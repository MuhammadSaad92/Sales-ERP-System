{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'add_purchase.css' %}">
{% endblock %}

{% block content %}
<div class="main-content">
    <h2>Update Purchase Order {{ form.instance.po_number|default:"PO#" }}</h2>
    
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    
    {% if form.errors or formset.errors or formset.non_form_errors %}
    <div class="alert alert-danger">
        <strong>Form Errors:</strong>
        <ul>
            {% for field, errors in form.errors.items %}
            <li>{{ field }}: {{ errors }}</li>
            {% endfor %}
            {% for form in formset %}
            {% for field, errors in form.errors.items %}
            <li>Item {{ forloop.counter }} - {{ field }}: {{ errors }}</li>
            {% endfor %}
            {% endfor %}
            {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
    
    <form method="post">
        {% csrf_token %}
        
        <div class="purchase-header">
            <div class="column1">
                <div class="form-group">
                    <label for="id_supplier">Supplier (Optional)</label>
                    {{ form.supplier }}
                    {% if form.supplier.errors %}
                    <div class="error">{{ form.supplier.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="column2">
                <div class="form-group">
                    <label for="id_purchase_date">Purchase Date</label>
                    {{ form.purchase_date }}
                    {% if form.purchase_date.errors %}
                    <div class="error">{{ form.purchase_date.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table class="item-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Stock</th>
                        <th>Ordered Qty</th>
                        <th>Received Qty</th>
                        <th>Unit Price</th>
                        <th>Discount %</th>
                        <th>Discount Value</th>
                        <th>VAT %</th>
                        <th>VAT Value</th>
                        <th>Total</th>
                        <th>Outstanding Qty</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="item-formset">
                    {% for item_form in formset %}
                    <tr class="item-row">
                        <td>
                            {{ item_form.id }}
                            <div class="autocomplete-container">
                                <input type="text" class="product-input" placeholder="Type Product Name" 
                                       value="{{ item_form.instance.product.name|default_if_none:'Unknown Product' }}" readonly>
                                {{ item_form.product }}
                                <div class="suggestions"></div>
                            </div>
                            {% if item_form.product.errors %}
                            <div class="error">{{ item_form.product.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.stock }}
                            {% if item_form.stock.errors %}
                            <div class="error">{{ item_form.stock.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.ordered_quantity }}
                            {% if item_form.ordered_quantity.errors %}
                            <div class="error">{{ item_form.ordered_quantity.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.received_quantity }}
                            {% if item_form.received_quantity.errors %}
                            <div class="error">{{ item_form.received_quantity.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.unit_price }}
                            {% if item_form.unit_price.errors %}
                            <div class="error">{{ item_form.unit_price.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.discount_percent }}
                            {% if item_form.discount_percent.errors %}
                            <div class="error">{{ item_form.discount_percent.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.discount_value }}
                            {% if item_form.discount_value.errors %}
                            <div class="error">{{ item_form.discount_value.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.vat_percent }}
                            {% if item_form.vat_percent.errors %}
                            <div class="error">{{ item_form.vat_percent.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.vat_value }}
                            {% if item_form.vat_value.errors %}
                            <div class="error">{{ item_form.vat_value.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.total }}
                            {% if item_form.total.errors %}
                            <div class="error">{{ item_form.total.errors }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if item_form.instance.pk %}
                                {{ item_form.instance.ordered_quantity|default:0|add:"-"|add:item_form.instance.received_quantity|default:0 }}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.DELETE }}
                            <button type="button" class="delete-row btn btn-delete">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {{ formset.management_form }}
        </div>
        
        <div class="summary">
            <div class="form-group">
                <label for="id_total_discount">Total Discount</label>
                {{ form.total_discount }}
                {% if form.total_discount.errors %}
                <div class="error">{{ form.total_discount.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="id_total_vat">Total VAT</label>
                {{ form.total_vat }}
                {% if form.total_vat.errors %}
                <div class="error">{{ form.total_vat.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="id_grand_total">Grand Total</label>
                {{ form.grand_total }}
                {% if form.grand_total.errors %}
                <div class="error">{{ form.grand_total.errors }}</div>
                {% endif %}
            </div>
                
            <div class="form-group">
                <label for="id_purchase_discount">Purchase Discount</label>
                {{ form.purchase_discount }}
                {% if form.purchase_discount.errors %}
                <div class="error">{{ form.purchase_discount.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="id_paid_amount">Paid Amount</label>
                {{ form.paid_amount }}
                {% if form.paid_amount.errors %}
                <div class="error">{{ form.paid_amount.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="id_due_amount">Due Amount</label>
                {{ form.due_amount|default:'<input type="number" name="due_amount" id="id_due_amount" readonly>' }}
                {% if form.due_amount.errors %}
                <div class="error">{{ form.due_amount.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="id_payment_type">Payment Type</label>
                {{ form.payment_type }}
                {% if form.payment_type.errors %}
                <div class="error">{{ form.payment_type.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <button type="submit" class="submit-button">Update</button>
        <a href="{% url 'manage_purchase_order' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>

<script>
    const products = [
        {% for product in formset.forms.0.fields.product.queryset %}
        {
            id: "{{ product.id }}",
            name: "{{ product.name|escapejs }}",
            sku: "{{ product.sku|escapejs }}",
            costPrice: "{{ product.cost_price }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    let selectedProductIds = new Set();
    
    function calculateRow(row) {
        const orderedQty = parseFloat(row.querySelector('[name$="ordered_quantity"]').value) || 0;
        const unitPrice = parseFloat(row.querySelector('[name$="unit_price"]').value) || 0;
        const discountPercent = parseFloat(row.querySelector('[name$="discount_percent"]').value) || 0;
        const vatPercent = parseFloat(row.querySelector('[name$="vat_percent"]').value) || 0;
        
        const subtotal = orderedQty * unitPrice;
        const discountValue = (subtotal * discountPercent) / 100;
        const vatValue = ((subtotal - discountValue) * vatPercent) / 100;
        const total = subtotal - discountValue + vatValue;
        
        row.querySelector('[name$="discount_value"]').value = discountValue.toFixed(2);
        row.querySelector('[name$="vat_value"]').value = vatValue.toFixed(2);
        row.querySelector('[name$="total"]').value = total.toFixed(2);
        
        const receivedQty = parseFloat(row.querySelector('[name$="received_quantity"]').value) || 0;
        const outstandingQtyCell = row.cells[10];
        outstandingQtyCell.textContent = (orderedQty - receivedQty).toFixed(0);
        
        updateSummary();
    }
    
    function updateSummary() {
        const rows = document.querySelectorAll('#item-formset .item-row');
        let totalDiscount = 0;
        let totalVat = 0;
        let grandTotal = 0;
        
        rows.forEach(row => {
            if (!row.querySelector('[name$="DELETE"]').checked) {
                totalDiscount += parseFloat(row.querySelector('[name$="discount_value"]').value) || 0;
                totalVat += parseFloat(row.querySelector('[name$="vat_value"]').value) || 0;
                grandTotal += parseFloat(row.querySelector('[name$="total"]').value) || 0;
            }
        });
        
        const purchaseDiscount = parseFloat(document.getElementById('id_purchase_discount').value) || 0;
        totalDiscount += purchaseDiscount;
        grandTotal -= purchaseDiscount;
        
        const paidAmount = parseFloat(document.getElementById('id_paid_amount').value) || 0;
        const dueAmount = grandTotal - paid_amount;
        
        document.getElementById('id_total_discount').value = totalDiscount.toFixed(2);
        document.getElementById('id_total_vat').value = totalVat.toFixed(2);
        document.getElementById('id_grand_total').value = grandTotal.toFixed(2);
        document.getElementById('id_due_amount').value = dueAmount.toFixed(2);
    }
    
    document.querySelectorAll('#item-formset .item-row').forEach(row => {
        const inputs = row.querySelectorAll(
            '[name$="ordered_quantity"], [name$="unit_price"], ' +
            '[name$="discount_percent"], [name$="vat_percent"], ' +
            '[name$="received_quantity"]'
        );
        
        inputs.forEach(input => {
            input.addEventListener('input', () => calculateRow(row));
        });
        
        const productInput = row.querySelector('.product-input');
        const productIdInput = row.querySelector('[name$="product"]');
        if (productInput && productIdInput && productIdInput.value) {
            const product = products.find(p => p.id === productIdInput.value);
            if (product) {
                selectedProductIds.add(product.id);
                productInput.value = product.name;
                row.querySelector('[name$="unit_price"]').value = parseFloat(product.costPrice).toFixed(2);
                row.querySelector('[name$="stock"]').value = product.sku || '';
                calculateRow(row);
            } else {
                console.warn(`Product with ID ${productIdInput.value} not found in products array.`);
                productInput.value = 'Unknown Product (ID: ' + productIdInput.value + ')';
            }
        }
        
        const deleteBtn = row.querySelector('.delete-row');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                const productId = row.querySelector('[name$="product"]').value;
                if (productId) selectedProductIds.delete(productId);
                const deleteInput = row.querySelector('[name$="DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none';
                }
                updateSummary();
            });
        }
    });
    
    document.querySelectorAll('#id_purchase_discount, #id_paid_amount').forEach(input => {
        input.addEventListener('input', updateSummary);
    });
    
    updateSummary();
</script>
{% endblock %}