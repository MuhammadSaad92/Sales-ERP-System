{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'add_purchase.css' %}">
{% endblock %}

{% block content %}
    <div class="main-content">
        <h2>{% if purchase %}Update Purchase{% else %}Add Purchase{% endif %}</h2>
        <form method="POST" action="{% if purchase %}{% url 'update_purchase' purchase.id %}{% else %}{% url 'add_purchase' %}{% endif %}">
            {% csrf_token %}
            <div class="purchase-header">
                <div class="column1">
                    <div class="form-group">
                        <label for="id_supplier">Supplier</label>
                        {{ form.supplier }}
                        {% if form.supplier.errors %}
                            <div class="error">{{ form.supplier.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="id_challan_no">Invoice No.</label>
                        {{ form.challan_no }}
                        {% if form.challan_no.errors %}
                            <div class="error">{{ form.challan_no.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="column2">
                    <div class="form-group">
                        <label for="id_purchase_date">Purchase Date</label>
                        {{ form.purchase_date }}
                        {% if form.purchase_date.errors %}
                            <div class="error">{{ form.purchase_date.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="id_details">Details</label>
                        {{ form.details }}
                        {% if form.details.errors %}
                            <div class="error">{{ form.details.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="item-table">
                    <thead>
                        <tr>
                            <th>Item Information</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Discount %</th>
                            <th>Dis. Value</th>
                            <th>Vat %</th>
                            <th>Vat Value</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="item-formset">
                        {{ formset.management_form }}
                        {% for item_form in formset %}
                            <tr class="item-row">
                                <td>
                                    <div class="autocomplete-container">
                                        <input type="text" class="product-input" value="{% if item_form.instance.product %}{{ item_form.instance.product.name }}{% endif %}" placeholder="Type product name" required>
                                        <input type="hidden" name="{{ item_form.prefix }}-product" id="id_{{ item_form.prefix }}-product" class="product-id" value="{% if item_form.instance.product %}{{ item_form.instance.product.id }}{% endif %}">
                                        <div class="suggestions"></div>
                                    </div>
                                    {% if item_form.product.errors %}
                                        <div class="error">{{ item_form.product.errors }}</div>
                                    {% endif %}
                                </td>
                                <td>{{ item_form.quantity }}{% if item_form.quantity.errors %}<div class="error">{{ item_form.quantity.errors }}</div>{% endif %}</td>
                                <td>{{ item_form.rate }}{% if item_form.rate.errors %}<div class="error">{{ item_form.rate.errors }}</div>{% endif %}</td>
                                <td>{{ item_form.discount_percent }}{% if item_form.discount_percent.errors %}<div class="error">{{ item_form.discount_percent.errors }}</div>{% endif %}</td>
                                <td>{{ item_form.discount_value }}{% if item_form.discount_value.errors %}<div class="error">{{ item_form.discount_value.errors }}</div>{% endif %}</td>
                                <td>{{ item_form.vat_percent }}{% if item_form.vat_percent.errors %}<div class="error">{{ item_form.vat_percent.errors }}</div>{% endif %}</td>
                                <td>{{ item_form.vat_value }}{% if item_form.vat_value.errors %}<div class="error">{{ item_form.vat_value.errors }}</div>{% endif %}</td>
                                <td>{{ item_form.total }}{% if item_form.total.errors %}<div class="error">{{ item_form.total.errors }}</div>{% endif %}</td>
                                <td>
                                    {% if item_form.instance.pk %}
                                        {{ item_form.DELETE }}
                                        <button type="button" class="delete-row btn btn-delete">✖</button>
                                    {% else %}
                                        <button type="button" class="delete-row btn btn-delete" style="display:none;">✖</button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" id="add-item-btn" class="btn btn-add">Add More</button>
            </div>

            <div class="summary">
                <div class="form-group">
                    <label for="id_purchase_discount">Purchase Discount:</label>
                    {{ form.purchase_discount }}
                    {% if form.purchase_discount.errors %}<div class="error">{{ form.purchase_discount.errors }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="id_total_discount">Total Discount:</label>
                    {{ form.total_discount }}
                    {% if form.total_discount.errors %}<div class="error">{{ form.total_discount.errors }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="id_total_vat">Total VAT:</label>
                    {{ form.total_vat }}
                    {% if form.total_vat.errors %}<div class="error">{{ form.total_vat.errors }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="id_grand_total">Grand Total:</label>
                    {{ form.grand_total }}
                    {% if form.grand_total.errors %}<div class="error">{{ form.grand_total.errors }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="id_paid_amount">Paid Amount:</label>
                    {{ form.paid_amount }}
                    {% if form.paid_amount.errors %}<div class="error">{{ form.paid_amount.errors }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="id_due_amount">Due Amount:</label>
                    {{ form.due_amount }}
                    {% if form.due_amount.errors %}<div class="error">{{ form.due_amount.errors }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label for="id_payment_type">Payment Type:</label>
                    {{ form.payment_type }}
                    {% if form.payment_type.errors %}<div class="error">{{ form.payment_type.errors }}</div>{% endif %}
                </div>
            </div>

            <button type="submit" class="submit-button">Save</button>
        </form>
    </div>

    <script>
        const products = [
            {% for product in formset.forms.0.fields.product.queryset %}
                {
                    id: "{{ product.id }}",
                    name: "{{ product.name|escapejs }}",
                    costPrice: "{{ product.cost_price }}",
                    vatPercent: "{{ product.vat_percentage }}"
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        let selectedProductIds = new Set();

        function calculateItemRow(row) {
            const quantity = parseFloat(row.querySelector('[name$="quantity"]').value) || 0;
            const rate = parseFloat(row.querySelector('[name$="rate"]').value) || 0;
            const discountPercent = parseFloat(row.querySelector('[name$="discount_percent"]').value) || 0;
            const vatPercent = parseFloat(row.querySelector('[name$="vat_percent"]').value) || 0;

            const subtotal = quantity * rate;
            const discountValue = (subtotal * discountPercent) / 100;
            const vatValue = ((subtotal - discountValue) * vatPercent) / 100;
            const total = subtotal - discountValue + vatValue;

            row.querySelector('[name$="discount_value"]').value = discountValue.toFixed(2);
            row.querySelector('[name$="vat_value"]').value = vatValue.toFixed(2);
            row.querySelector('[name$="total"]').value = total.toFixed(2);

            updateSummary();
        }

        function updateSummary() {
            const rows = document.querySelectorAll('#item-formset .item-row');
            let totalDiscount = 0, totalVat = 0, itemsTotal = 0;

            rows.forEach(row => {
                totalDiscount += parseFloat(row.querySelector('[name$="discount_value"]').value) || 0;
                totalVat += parseFloat(row.querySelector('[name$="vat_value"]').value) || 0;
                itemsTotal += parseFloat(row.querySelector('[name$="total"]').value) || 0;
            });

            const purchaseDiscount = parseFloat(document.getElementById('id_purchase_discount').value) || 0;
            const totalDiscountWithPurchase = totalDiscount + purchaseDiscount;
            const grandTotal = itemsTotal - purchaseDiscount;
            const paidAmount = parseFloat(document.getElementById('id_paid_amount').value) || grandTotal;
            const dueAmount = grandTotal - paidAmount;

            document.getElementById('id_total_discount').value = totalDiscountWithPurchase.toFixed(2);
            document.getElementById('id_total_vat').value = totalVat.toFixed(2);
            document.getElementById('id_grand_total').value = grandTotal.toFixed(2);
            document.getElementById('id_paid_amount').value = paidAmount.toFixed(2);
            document.getElementById('id_due_amount').value = dueAmount.toFixed(2);
        }

        function populateProductDetails(row, product) {
            if (selectedProductIds.has(product.id)) {
                alert(`Product "${product.name}" is already selected.`);
                row.querySelector('.product-input').value = '';
                row.querySelector('.product-id').value = '';
                return false;
            }

            row.querySelector('.product-input').value = product.name;
            row.querySelector('.product-id').value = product.id;
            row.querySelector('[name$="rate"]').value = parseFloat(product.costPrice).toFixed(2);
            row.querySelector('[name$="vat_percent"]').value = parseFloat(product.vatPercent).toFixed(2);
            selectedProductIds.add(product.id);
            calculateItemRow(row);
            return true;
        }

        function setupAutocomplete(input) {
            const container = input.closest('.autocomplete-container');
            const suggestions = container.querySelector('.suggestions');
            const productIdInput = container.querySelector('.product-id');

            input.addEventListener('input', () => {
                const query = input.value.toLowerCase();
                suggestions.innerHTML = '';
                productIdInput.value = '';
                suggestions.style.display = 'none';

                if (query.length < 1) return;

                const matches = products.filter(p => 
                    p.name.toLowerCase().includes(query) && 
                    !selectedProductIds.has(p.id)
                );

                matches.forEach(product => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = product.name;
                    div.addEventListener('click', () => {
                        if (populateProductDetails(input.closest('.item-row'), product)) {
                            suggestions.style.display = 'none';
                        }
                    });
                    suggestions.appendChild(div);
                });

                suggestions.style.display = matches.length ? 'block' : 'none';
            });

            input.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestions.style.display = 'none';
                    if (input.value && !productIdInput.value) {
                        input.value = '';
                        alert('Please select a valid product from the suggestions.');
                    }
                }, 200);
            });
        }

        document.getElementById('add-item-btn').addEventListener('click', function() {
            const tbody = document.getElementById('item-formset');
            const totalForms = document.getElementById('id_items-TOTAL_FORMS');
            const formIndex = parseInt(totalForms.value);

            const newRow = document.createElement('tr');
            newRow.className = 'item-row';
            newRow.innerHTML = `
                <td>
                    <div class="autocomplete-container">
                        <input type="text" class="product-input" placeholder="Type product name" required>
                        <input type="hidden" name="items-${formIndex}-product" id="id_items-${formIndex}-product" class="product-id">
                        <div class="suggestions"></div>
                    </div>
                </td>
                <td><input type="number" name="items-${formIndex}-quantity" id="id_items-${formIndex}-quantity" value="1" min="1" step="1"></td>
                <td><input type="number" name="items-${formIndex}-rate" id="id_items-${formIndex}-rate" step="0.01" value="0.00" min="0"></td>
                <td><input type="number" name="items-${formIndex}-discount_percent" id="id_items-${formIndex}-discount_percent" step="0.01" value="0.00" min="0" max="100"></td>
                <td><input type="number" name="items-${formIndex}-discount_value" id="id_items-${formIndex}-discount_value" step="0.01" value="0.00" readonly></td>
                <td><input type="number" name="items-${formIndex}-vat_percent" id="id_items-${formIndex}-vat_percent" step="0.01" value="0.00" min="0" max="100"></td>
                <td><input type="number" name="items-${formIndex}-vat_value" id="id_items-${formIndex}-vat_value" step="0.01" value="0.00" readonly></td>
                <td><input type="number" name="items-${formIndex}-total" id="id_items-${formIndex}-total" step="0.01" value="0.00" readonly></td>
                <td><button type="button" class="delete-row btn btn-delete">✖</button></td>
            `;
            tbody.appendChild(newRow);
            totalForms.value = formIndex + 1;

            const productInput = newRow.querySelector('.product-input');
            setupAutocomplete(productInput);
            ['quantity', 'rate', 'discount_percent', 'vat_percent'].forEach(field => {
                newRow.querySelector(`[name$="${field}"]`).addEventListener('input', () => calculateItemRow(newRow));
            });

            newRow.querySelector('.delete-row').addEventListener('click', function() {
                const productId = newRow.querySelector('.product-id').value;
                if (productId) selectedProductIds.delete(productId);
                newRow.remove();
                totalForms.value = parseInt(totalForms.value) - 1;
                updateSummary();
            });
        });

        document.querySelectorAll('#item-formset .item-row').forEach(row => {
            const productInput = row.querySelector('.product-input');
            const productIdInput = row.querySelector('.product-id');
            if (productInput && productIdInput) {
                setupAutocomplete(productInput);
                if (productIdInput.value) {
                    const product = products.find(p => p.id === productIdInput.value);
                    if (product) {
                        selectedProductIds.add(product.id);
                        populateProductDetails(row, product);
                    }
                }
            }
            ['quantity', 'rate', 'discount_percent', 'vat_percent'].forEach(field => {
                const fieldInput = row.querySelector(`[name$="${field}"]`);
                if (fieldInput) {
                    fieldInput.addEventListener('input', () => calculateItemRow(row));
                }
            });
            const deleteBtn = row.querySelector('.delete-row');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    const productId = row.querySelector('.product-id').value;
                    if (productId) selectedProductIds.delete(productId);
                    row.remove();
                    document.getElementById('id_items-TOTAL_FORMS').value = parseInt(document.getElementById('id_items-TOTAL_FORMS').value) - 1;
                    updateSummary();
                });
            }
        });

        document.getElementById('id_purchase_discount').addEventListener('input', updateSummary);
        document.getElementById('id_paid_amount').addEventListener('input', () => {
            const grandTotal = parseFloat(document.getElementById('id_grand_total').value) || 0;
            const paidAmount = parseFloat(document.getElementById('id_paid_amount').value) || 0;
            document.getElementById('id_due_amount').value = (grandTotal - paidAmount).toFixed(2);
        });

        document.querySelectorAll('#item-formset .item-row').forEach(calculateItemRow);
        updateSummary();
    </script>
{% endblock %}